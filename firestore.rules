rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =================================
    // COLEÇÃO DE USUÁRIOS (USERS)
    // =================================
    match /users/{userId} {
      // Permite que um usuário leia e atualize seu próprio perfil.
      allow read, update: if request.auth.uid == userId;
      // Permite que qualquer usuário autenticado crie seu perfil (cadastro).
      allow create: if request.auth != null;
      // Permite que um usuário delete seu próprio perfil.
      allow delete: if request.auth.uid == userId;
    }

    // =================================
    // COLEÇÃO DE GRUPOS (GROUPS)
    // =================================
    match /groups/{groupId} {
      // Permite que qualquer usuário autenticado leia os dados de um grupo.
      allow read: if request.auth != null;
      // Permite que um gestor crie, atualize ou delete seu próprio grupo.
      allow create, update, delete: if request.auth.uid == groupId;

      // =================================
      // SUBCOLEÇÃO DE PARTICIPANTES (ATTENDEES)
      // =================================
      match /games/{gameId}/attendees/{userId} {
          // Permite que qualquer usuário do grupo leia a lista de participantes.
          allow read: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.groupId == groupId;
          
          // Permite que um usuário defina seu próprio status de presença se ele pertencer ao grupo.
          allow create, update: if request.auth.uid == userId && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.groupId == groupId;
      }
    }
  }
}
