rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Permite que um usuário autenticado crie, leia, atualize e delete seu próprio documento.
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Permite que gestores de grupo leiam e escrevam nos seus próprios grupos.
    match /groups/{groupId} {
       allow read, write: if request.auth != null && request.auth.uid == groupId;
    }
    
    // Permite que usuários autenticados no grupo possam ler/escrever nos documentos de jogos (presença, gols).
    match /groups/{groupId}/games/{gameId}/{document=**} {
      allow read, write: if request.auth != null && exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.groupId == groupId;
    }

    // Permite que gestores de grupo gerenciem os pagamentos dentro de seus grupos.
    match /groups/{groupId}/payments/{paymentId} {
        allow read, write: if request.auth != null && get(/databases/$(database)/documents/groups/$(groupId)).data.managerId == request.auth.uid;
    }
  }
}
